---
title: "Tackling The Reproducibility Crisis In Ecology"
subtitle: "ESA Annual Meeting 2024"
author: "Peter Levy, UK Centre for Ecology & Hydrology"
date: "</br> '2024-08-07'"
format:
  revealjs:
    theme: [default, ceh.scss]
    slide-number: true
    chalkboard:
      buttons: false
    preview-links: auto
    logo: images/logo/UKCEH-Logo_Short_Positive_RGB.png
execute:
  cache: true
---

```{r render, eval = FALSE, include=FALSE}
# use quarto installed with Rstudio; set path first time
# Sys.setenv(QUARTO_PATH="C:/Program Files/RStudio/resources/app/bin/quarto/bin/quarto.exe")
# renv::install("leaflet")
library(quarto)
system.time(quarto_render("./index.qmd"))
```

```{r startup}
library(data.table)
library(ggplot2)
```

## The Reproducibility Crisis
1. What is it?
2. Causes: the publishing filter
3. Causes: high "false discovery" rates
4. Ecological examples
5. Solutions: a change in perspective in statistical thinking

## The Reproducibility Crisis
::: columns
::: {.column width="60%"}
![\label{fig:Ioannidis2005} Ioannidis, 2005, PLOS Medicine](images/Ioannidis2005.png)
:::
::: {.column width="40%"}


"Reproducibility"<br />
of [results]{style="color:red"},<br />
not methods.
:::
:::

## Unpublished work as Dark Matter {background="#43464B" background-image="images/milky-way.jpeg"}

```{r darkmatter}
library(magrittr)
library(dplyr)
library(ggplot2)
set.seed(456)
y <- rnorm(10000, 0, 33)
# hist(y)
cutoff <- quantile(y, probs = 0.95)

df_dens <- density(y, from = -100, to = 100) %$%
  data.frame(x = x, y = y) %>%
  mutate(area = x >= cutoff)
names(df_dens) <- c("Effect_size", "Frequency", "Published")
p_dark <- ggplot(data = df_dens, aes(x = Effect_size, ymin = 0, ymax = Frequency, fill = Published)) +
  geom_ribbon() +
  scale_fill_manual(values = c("dark grey", "yellow")) +
  geom_line(aes(y = Frequency)) +
  geom_vline(xintercept = cutoff, colour = "red") +
  annotate(geom = 'text', x = cutoff, y = 0.0125, colour = "red", label = 'Significant at p=5%', hjust = -0.1)
print(p_dark)

# remove the significance level criterion
cutoff <- quantile(y, probs = 0.001)

df_dens <- density(y, from = -100, to = 100) %$%
  data.frame(x = x, y = y) %>%
  mutate(area = x >= cutoff)
names(df_dens) <- c("Effect_size", "Frequency", "Published")
p_light <- ggplot(data = df_dens, aes(x = Effect_size, ymin = 0, ymax = Frequency, fill = Published)) +
  geom_ribbon() +
  scale_fill_manual(values = c("dark grey", "yellow")) +
  geom_line(aes(y = Frequency))
```

We can only see 5% of the universe.

<!--- {reproducibility crisis -->
## *"Why most published research findings are false"*

- Low prior probabilities - unlikely / rare effects
- Low statistical power - low signal:noise
- Bias - systematic uncertainties in observation process

-> High "false discovery rates", often much higher than 5 %

<!--- } -->

# Understanding false discovery rates {background="#37a635"}

## Disease testing
![](images/false_discovery_covid.png)

## Generic experiments
![](images/false_discovery_expt_1.png)

## Generic experiments
![](images/false_discovery_expt_2.png)

## Effect of prior probability
```{r plotfdr}
alpha <- 0.05
v_power <- c(0.2, 0.4, 0.8)
v_prior <- seq(from = 0, to = 1, by = 0.01)
v_bias  <- seq(from = 0, to = 1, by = 0.05)
dt <- as.data.table(expand.grid(power = v_power, prior = v_prior, u = v_bias))

# expected fdr, from Colquhoun 2014
dt[, ppv := (prior * power)  / (prior * power  + alpha * (1 - prior))]
dt[, fdr := 1 - ppv]

# without bias, from Ioannidis 2005
dt[, R := prior / (1- prior)] # prior odds
# dt[, PPV := power * R / (R - (1 - power) * R + alpha)]
# with bias, u, from Ioannidis 2005
dt[, ppv_u := (power * R + u * (1- power) * R) /
  (R + alpha - (1 - power) * R + u - u * alpha + u * (1 - power) * R)]
dt[, fdr_u := 1 - ppv_u]

p <- ggplot(dt[power == 0.8], aes(prior, fdr*100, colour = as.factor(power), group = power))
p <- p + geom_line() + ylim(0, 100)
p <- p + xlab("Prior probability") + ylab("False Discovery Rate (%)")
# add legend title
p <- p + scale_color_discrete(name = "Power")
p
```

## Generic experiments: low power
![](images/false_discovery_expt_3.png)

## Effect of low power
```{r lowpower}
p <- ggplot(dt, aes(prior, fdr*100, colour = as.factor(power), group = power))
p <- p + geom_line() + ylim(0, 100)
p <- p + xlab("Prior probability") + ylab("False Discovery Rate (%)")
# add legend title
p <- p + scale_color_discrete(name = "Power")
p
```

## Generic experiments: bias
![](images/false_discovery_expt_4.png)

## Effect of bias
```{r bias}
p <- ggplot(dt[prior == 0.5], aes(u, fdr_u*100, colour = as.factor(power), group = power))
p <- p + geom_line() + ylim(0, 100) + xlim(0, 1)
p <- p + xlab("Bias") + ylab("False Discovery Rate (%)")
p <- p + scale_color_discrete(name = "Power")
#p <- p + facet_wrap(~ power, ncol = 1)
p
```

## The ASA statement
::: columns
::: {.column width="50%"}
![](images/Wasserstein.png)

2016
:::
::: {.column width="50%"}
![](images/Wasserstein2.png)
2019
:::
:::
 Stop using *p* values and "statistical significance".

# An ecological example: soil carbon change {background="#37a635"}

## "Nature-based solutions" to climate change

::: columns
::: {.column width="40%"}
- "rejuvenative farming"
- biochar
- reduced stocking
- rewilding
:::

::: {.column width="60%"}
![](images/soc_activities.png){.border .border-thick}
:::
:::

## "Nature-based solutions" to climate change

::: columns
::: {.column width="50%"}
Barley
![](images/barley.jpg){.border .border-thick}
:::
::: {.column width="50%"}
*Miscanthus*
![](images/miscanthus.jpg){.border .border-thick}
:::
:::

## Measuring soil carbon: field
![](images/soil_coring_1.png)
![](images/soil_coring_2.png)
Take soil cores
![](images/soil_core.png)

## Measuring soil carbon: lab
![](images/measuring_LOI.png)

## Soil carbon: integrate over depth

::: columns
::: {.column width="70%"}
![](images/soil_C_with_depth.png)
:::

::: {.column width="30%"}
$\mathrm{log} C = \alpha + \beta \times \mathrm{depth}$
:::
:::

## Soil carbon: integrate over space

![](images/EC_SoilC_maps_eachYear.png)


## Soil carbon: uncertainties

>- We would typically say we have "measurements of soil carbon".
>- But we actually have measurements of weight loss
>- from a sample of a sample ...
>- from which we predict carbon fraction with a model ...
>- and predict carbon stock to depth with a model ...
>- and extrapolate this in space with a model ...
>- and we (usually) ignore most of the uncertainties!

## Soil carbon: uncertainties

Systematic uncertainties (bias) from different:

- surveyors
- sampling protocols
- areas & depths sampled
- labs & instruments
- lab protocols

Very hard to be consistent over >10 years.

## Results - low power and bias
```{r fdrsoilc}
source("R/false_discovery_rate.R")
n_sims <- 20000
mu_t1 <- 15
sigma_s <- 1.5
d_true  <- mu_t1 * 0.05
v_n    <- c(5, 6, 7, 8, 9, 10, 20, 30, 40, 50, 60, 80, 100)
# plot(v_n, v_fdr)
# calc_fdr(n = 9, mu_t1 = mu_t1, d_true = 0.75, sigma_s = sigma_s, sigma_b = 0, n_sims = 1000)
v_fdr <- sapply(v_n, calc_fdr, mu_t1 = mu_t1, d_true = d_true, sigma_s = sigma_s, sigma_b = 0, n_sims = n_sims)
dt_b0 <- data.table(n = v_n, fdr = v_fdr, bias = 0)
v_fdr <- sapply(v_n, calc_fdr, mu_t1 = mu_t1, d_true = d_true, sigma_s = sigma_s, sigma_b = 0.5, n_sims = n_sims)
dt_b1 <- data.table(n = v_n, fdr = v_fdr, bias = 0.5)
v_fdr <- sapply(v_n, calc_fdr, mu_t1 = mu_t1, d_true = d_true, sigma_s = sigma_s, sigma_b = 1.0, n_sims = n_sims)
dt_b2 <- data.table(n = v_n, fdr = v_fdr, bias = 1.0)
dt <- rbind(dt_b0, dt_b1, dt_b2)

p <- ggplot(dt, aes(n, fdr*100, color = as.factor(bias)))
p <- p + geom_line(linewidth = 1) + ylim(0, 70)
p <- p + geom_vline(xintercept = 9, linetype = "dashed", colour = "black")
p <- p + xlab("Number of samples") + ylab("False Discovery Rate (%)")
# add legend title
p <- p + scale_color_discrete(name = "Bias")
p
```

Prior probability of 0.5

## Results - low prior probability

```{r fdrsoilc2}
P_H1 <- 0.3
v_fdr <- sapply(v_n, calc_fdr, mu_t1 = mu_t1, d_true = d_true, sigma_s = sigma_s, sigma_b = 0, P_H1 = P_H1, n_sims = n_sims)
dt_b0 <- data.table(n = v_n, fdr = v_fdr, bias = 0)
v_fdr <- sapply(v_n, calc_fdr, mu_t1 = mu_t1, d_true = d_true, sigma_s = sigma_s, sigma_b = 0.5, P_H1 = P_H1, n_sims = n_sims)
dt_b1 <- data.table(n = v_n, fdr = v_fdr, bias = 0.5)
v_fdr <- sapply(v_n, calc_fdr, mu_t1 = mu_t1, d_true = d_true, sigma_s = sigma_s, sigma_b = 1.0, P_H1 = P_H1, n_sims = n_sims)
dt_b2 <- data.table(n = v_n, fdr = v_fdr, bias = 1.0)
dt <- rbind(dt_b0, dt_b1, dt_b2)

p <- ggplot(dt, aes(n, fdr*100, color = as.factor(bias)))
p <- p + geom_line(linewidth = 1) + ylim(0, 70)
p <- p + geom_vline(xintercept = 9, linetype = "dashed", colour = "black")
p <- p + xlab("Number of samples") + ylab("False Discovery Rate (%)")
# add legend title
p <- p + scale_color_discrete(name = "Bias")
p
```

Prior probability of 0.3

# Solutions {background="#37a635"}

## A Copernican Revolution {background-color="white" background-video="images/copernican_revolution.mp4"}

## A Copernican Revolution {background-color="white" background-image="images/copernican_revolution.png"}

## What does this mean in practice? {background="#43464B" background-image="images/milky-way.jpeg"}
```{r darkmatter2}
print(p_dark)
```

Don't focus on testing a null hypothesis.

## What does this mean in practice? {background="#43464B" background-image="images/milky-way.jpeg"}
```{r darkmatter3}
print(p_light)
```
Characterise the model parameter posterior distribution.


## Soil carbon change
- model the OP
- provide the posterior distribution
- [change | data, $\theta_{OP}$]
- monetize the change, accounting for uncertainty

## Slides online

[https://peterlevy.github.io/reproducibility_esa](https://peterlevy.github.io/reproducibility_esa)

# Final Thoughts {background="#37a635"}

## The real purpose of scientific method

*"... is to make sure Nature hasn't misled you into thinking you know something you don't actually know."*

Robert Pirsig, 1974


##
::: columns
::: {.column width="50%"}
*"All models are wrong, but some are useful."*

George Box, 1976.

![](images/george_box.jpg){width="50%"}
:::
::: {.column width="50%"}

:::
:::

##
::: columns
::: {.column width="50%"}
*"All models are wrong, but some are useful."*

George Box, 1976.

![](images/george_box.jpg){width="50%"}
:::
::: {.column width="50%"}
*"All [data]{style="color:red"} are wrong, but some are useful."*

Patterson & Gimlin, 1967

![](images/bigfoot.jpg)
:::
:::
